version: '3.8'

services:

  web:
    restart: always
    build:
      context: ./Datefix
      dockerfile: Dockerfile
    image: 172255399645.dkr.ecr.us-east-2.amazonaws.com/django-ec2:web
    expose:
      - "8000"
    links:
      - postgres:postgres
      - redis:redis
    env_file: env
    volumes:
      - static_volume:/datefix-1/static
    command: /usr/bin/gunicorn Datefix.wsgi:application -w 2 -b :8000

  nginx-proxy:
    container_name: nginx-proxy
    build: nginx
    image: 172255399645.dkr.ecr.us-east-2.amazonaws.com/django-ec2:nginx-proxy
    restart: always
    ports:
      - 443:443
      - 80:80
    volumes:
      - static_volume:/home/datefix/static
      - certs:/etc/nginx/certs
      - html:/usr/share/nginx/html
      - vhost:/etc/nginx/vhost.d
      - /var/run/docker.sock:/tmp/docker.sock:ro
    depends_on:
      - web

  nginx-proxy-letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    env_file:
      - .env.prod.proxy-companion
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - certs:/etc/nginx/certs
      - html:/usr/share/nginx/html
      - vhost:/etc/nginx/vhost.d
    depends_on:
      - nginx-proxy

  nginx:
    restart: always
    build: ./nginx/
    networks:
      - front
      - back
    ports:
      - "80:80"
    environment:
      - NGINX_HOST=datefix.me
      - NGINX_PORT=80
      - DAPHNE_HOST=daphne
      - DAPHEN_PORT=8000
    depends_on:
      - daphne
    links:
      - daphne
    command: /bin/bash -c "envsubst < /etc/nginx/conf.d/service.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

  redis:
    restart: always
    image: redis:latest
    networks:
      - back
    ports:
    - "6379:6379"
    expose:
      - "6379"

  datefix-1:
    build: .

  worker:
    image: "datefix-1:latest"
    build: .
    working_dir: /home/datefix-1
    command: bash -c "python manage.py runworker channels -v2"
    environment:
      - REDIS_HOST=redis
    networks:
      - front
      - back
    depends_on:
      - redis
    links:
      - redis
  daphne:
    image: "datefix-1: latest"
    build: .
    working_dir: /home/myproject
    command: bash -c "daphne -b 0.0.0.0 -p 8000 Datefix.asgi:channel_layer"
    ports:
      - "8000:8000"
    environment:
      - REDIS_HOST=redis
    networks:
      - front
      - back
    depends_on:
      - redis
    links:
      - redis
